<!DOCTYPE html>
<html>
<head>
    <title>HRRR Download Script Tips</title> 
    <script src="./js/site/siteopen.js"></script>
</head>
<body>
    <a name="TOP"></a>
    <script src="./js/site/sitemenu.js"></script>


<h1 align="center"><i class="fa fa-code fa-fw"></i> HRRR Download Scripting Tips</h1>
<script src='./js/HRRR_status.js'></script>

<div id="content">          
        
    <div class="row" id="content">
        <div class=" col-md-3">
                <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/hrrr_download_register.html" class="btn btn-danger btn-block">
                <i class="fa fa-user-plus"></i> Have you Registered?</a>        
        </div>
        <div class="col-md-3">
                <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/hrrr_practices.html" class="btn btn-warning btn-block">
                <i class="far fa-handshake"></i> Best Practices</a>
        </div>
        <div class="col-md-3">
                <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/hrrr_FAQ.html" class="btn btn-success btn-block">
                <i class="fa fa-info-circle"></i> HRRR FAQ</a>
        </div>
        <div class="col-md-3">
                <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/cgi-bin/hrrr_download.cgi" class="btn btn-primary btn-block">
                <i class="fa fa-cloud-download-alt"></i> Web Download Page</a>
        </div>
    </div>
    <br>
    <script src='./js/pando_status.js'></script>
    <div class="alert alert-warning">
        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
        <small><p>If you have not already, please 
                  <a class='alert-link' href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/hrrr_download_register.html">register</a>
                  as a user before downloading data. Citation details can be found at the bottom of this page.
        </small>
    </div>  

    <br>        
        <!-- Tabs -->
        <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#tab1"><i class="fas fa-link"></i> URL structure</a></li>
            <li><a data-toggle="tab" href="#tab2"><i class="fas fa-terminal"></i> cURL and wget</a></li>
            <li><a data-toggle="tab" href="#tab3"><i class="fab fa-python"></i> Python</a></li>
            <li><a data-toggle="tab" href="#tab4"><i class="far fa-clone"></i> rclone</a></li>
            <li><a data-toggle="tab" href="#tab5">Other</a></li>
        </ul>

        <div class="tab-content" id="content">
            <div id="tab1" class="tab-pane fade in active">
                <br>
                <p> You may write your own script to automate the download process,
                    but PLEASE do not download an excessive number of files in a short
                    period of time on multiple nodes (you agreed to not do this when you read the
                    Best Practices).
                <p> HRRR GRIB2 files are large. sfc files are >100 MB and prs files are >380 MB each.
                    If you download a day's worth of prs analyses, thats over 9 GB!
                <hr>
                <p> <b>GRIB2</b> files are downloaded from the URL<br> 
                    <div class="well well-sm">
                        <span style="font-family:monospace; padding-left:20px;">https://pando-rgw01.chpc.utah.edu/
                        <span style="color:red">[model type]</span>/
                        <span style="color:blue">[fields]</span>/
                        <span style="color:green">[YYYYMMDD]</span>/
                        <span style="color:darkorange">[file name]</span>
                    </div>

                <p> <b>Metadata</b> for each file can be viewed from the same URL except with <b>.idx</b> appended to the grib2 file name<br> 
                    <div class="well well-sm">
                        <span style="font-family:monospace; padding-left:20px;">https://pando-rgw01.chpc.utah.edu/
                        <span style="color:red">[model type]</span>/
                        <span style="color:blue">[fields]</span>/
                        <span style="color:green">[YYYYMMDD]</span>/
                        <span style="color:darkorange">[file name]</span>.idx
                    </div>
                <p> The model type and variable fields available include:
                <ul style="padding-left:40px">
                    <li><span style="color:red">[model type] <b>hrrr</b></span> for the operational HRRR
                        <ul style="padding-left:40px">
                                <li><span style="color:blue">[fields] <b>sfc</b></span>
                                <li><span style="color:blue">[fields] <b>prs</b></span>
                                <li><span style="color:blue">[fields] <b>subh</b></span> (sparse availability, if any)
                                <li><span style="color:blue">[fields] <b>nat</b></span> (sparse availability, if any)
                        </ul>
                    <li><span style="color:red">[model type] <b>hrrrX</b></span> for the experimental HRRR
                        <ul style="padding-left:40px">
                                <li><span style="color:blue">[fields] <b>sfc</b></span>
                        </ul>
                    <li><span style="color:red">[model type] <b>hrrrak</b></span> for HRRR Alaska
                        <ul style="padding-left:40px">
                                <li><span style="color:blue">[fields] <b>sfc</b><span>
                                <li><span style="color:blue">[fields] <b>prs</b></span>
                        </ul>
                </ul>
                <p> <span style="color:green">[YYYYMMDD]</span> represents the UTC date format (e.g. 20171228).
                <p> <span style="color:darkorange">[file name]</span> is in the format <b><span style="color:red">[model type]</span>.t[00-23]z.wrf<span style="color:blue">[fields]</span>f[00-18].grib2</b><br>
                    where the two digit number following <b>t</b> is the model run hour and the two digit number following <b>f</b> is the model forecast hour.
                
                <br><br>
                <table style="max-width:800px" class="table table-hover" align='center'>
                    <tr><th>Model Name</th><th>Model Type</th><th>Model Cycle</th><th>Archived Forecasts</th></tr>
                    <tr><td>Operational HRRR</td><td>hrrr</td><td>Hourly<br>range(0,23)</td><td>sfc: f00-f18<br>prs: f00</td></tr>
                    <tr><td>Experimental HRRR</td><td>hrrrX</td><td>Hourly<br>range(0,23)</td><td>sfc: f00</td></tr>
                    <tr><td>HRRR Alaska</td><td>hrrrak</td><td>Every 3 hours<br>range(0,23,3)</td><td>sfc: f00</td></tr>
                </table>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Example</h3>
                    </div>
                    <div class="panel-body" style="font-family:monospace">
                        <p>https://pando-rgw01.chpc.utah.edu/<span style="color:red">hrrr</span>/<span style="color:blue">sfc</span>/<span style="color:green">20180101</span>/<span style="color:darkorange">hrrr.t00z.wrfsfcf00.grib2</span>
                            <p>https://pando-rgw01.chpc.utah.edu/<span style="color:red">hrrr</span>/<span style="color:blue">sfc</span>/<span style="color:green">20180101</span>/<span style="color:darkorange">hrrr.t00z.wrfsfcf00.grib2.idx</span>
                    </div>
                </div>
                <div class="alert alert-info">
                        <i class="fas fa-info-circle fa-fw"></i> The <a class='alert-link' href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/cgi-bin/generic_pando_download.cgi?BUCKET=hrrr" data-toggle="tooltip" title="Alternative HRRR Download Page"> alternative download page</a>
                        may help you better understand the URL structure    
                </div>

                <!--
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">Special case: BUFR soundings</h3>
                    </div>
                    <div class="panel-body">
                        <p>You can download BUFR soundings for KSLC, KPVU, and KOGD
                            from the operational HRRR. For example:
                        <div class="well">https://pando-rgw01.chpc.utah.edu/hrrr/buf/YYYYMMDD/kslc_YYYYMMDDHH.buf</div>        
                    </div>
                </div>            
                -->


            </div>

            <div id="tab2" class="tab-pane fade"> 
                <br>            
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><b>cURL</b> download full file</h3>
                    </div>
                    <div class="panel-body" style="font-family:monospace">
                        curl -O https://pando-rgw01.chpc.utah.edu/hrrr/sfc/20180101/hrrr.t00z.wrfsfcf00.grib2
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><b>cURL</b> download full file and rename</h3>
                    </div>
                    <div class="panel-body" style="font-family:monospace">
                        curl -o hrrr20180101_00zf00.grib2 https://pando-rgw01.chpc.utah.edu/hrrr/sfc/20180101/hrrr.t00z.wrfsfcf00.grib2
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><b>wget</b> download full file</h3>
                    </div>
                    <div class="panel-body" style="font-family:monospace">
                        wget https://pando-rgw01.chpc.utah.edu/hrrr/sfc/20180101/hrrr.t00z.wrfsfcf00.grib2
                    </div>
                </div>
                <p>If you know the byte range of the variable you want (found from the .idx file), you can retrieve that single variable.
                    The .idx files share the same URL as the grib2, except with .idx appended to the end.
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><b>cURL</b> download a single variable</h3>
                    </div>
                    <div class="panel-body">
                    <p>From the <a href="https://pando-rgw01.chpc.utah.edu/hrrr/sfc/20180101/hrrr.t00z.wrfsfcf00.grib2.idx">.idx file</a>,
                       we see that the byte range for TMP:2 m starts at 34884036 and ends at 36136433.</p>
                    <p style="font-family:monospace">curl -o 20180101_00zf00_2mTemp.grib2 --range 34884036-36136433 https://pando-rgw01.chpc.utah.edu/hrrr/sfc/20180101/hrrr.t00z.wrfsfcf00.grib2
                    <p>After inspecting the file, you will see cURL has returned a valid grib2 file with one variable.</p>
                    </div>
                </div>
                <div class="panel panel-warning">
                    <div class="panel-heading">
                        <h3 class="panel-title"><b>cURL</b> download several variables</h3>
                    </div>
                    <div class="panel-body">
                    <p>Unfortunately, the <span style="font-family:monospace">curl --range</span> function wont work if you
                        request more than one range. I don't know why this doesn't
                        work, but it must be a limitation of the Pando archive.
                        Fortunately, similar variables are usually grouped together,
                        like U and V wind compenents, so you can request a range 
                        that spans the variables you want. This example gets 
                        TMP, POT, SPFH, DPT, RH, UGRD, VGRD, WIND at 2 meters.
                    <p style="font-family:monospace">curl -o 20180101_00zf00_2mTemp2mDPT10mwind.grib2 --range 34884036-44863087 https://pando-rgw01.chpc.utah.edu/hrrr/sfc/20180101/hrrr.t00z.wrfsfcf00.grib2
                    </div>
                </div>
                
            </div>

            <div id="tab3" class="tab-pane fade">
                <br>
                <p> I use Python version 3. Describing my set-up would be long, so just use these as a template.
                
                <p> There are two key packages that read GRIB2 files. Both can be downloaded via conda-forge.
                    <ol>
                        <li><b>pygrib</b>: This is what I started to learn and continue to use.
                                           <i>Not</i> available on Windows machines.
                                           (<a href='https://github.com/jswhit/pygrib'>source</a>)</li>
                        <li><b>cfgrib</b>: Fairly new and works well with xarray.
                                           Version 0.9.7 and greater can read HRRR files.
                                           This does work on Windows machines.
                                           (<a href='https://github.com/ecmwf/cfgrib'>source</a>)</li>
                    </ol>

                <br>
                
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Download full grib2 files</h3>
                    </div>
                    <div class="panel-body">
                        Download the full grib2 file from the Pando archive.
                        'sfc' files are about 150 MB each, and 'prs' files are
                        about 320 MB each.
                        <script src="https://gist.github.com/blaylockbk/78d4dd9c159e8974f288b0a57f68c266.js"></script>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Download single HRRR variable from file</h3>
                    </div>
                    <div class="panel-body">
                        It is more efficient if you only download the variables
                        you are interested in. While a full sfc file is about
                        150 MB, a single variable field is about 1 MB.
                        You can perform partial downloads of the grib2 files to 
                        extract the variables you want with cURL.
                        <br><br>
                        Main function: <b>download_HRRR_variable_from_pando()</b>
                        <script src="https://gist.github.com/blaylockbk/39d2c5244b988706d9c51dd9fd514650.js"></script>
                                       
                        Partial downloads with cURL require a known byte range.
                        The grbi2.idx (
                        <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/HRRR_archive/HRRR_v3_variables_SFC.pdf">
                        sfc example</a>
                        ,   
                        <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/HRRR_archive/HRRR_v3_variables_PRS.pdf">
                        prs example</a>
                        ) files are metadata text files that 
                        contain the begining byte of each
                        field in the file. <b>Each grib2 file has a unique
                        metadata file.</b> To find the byte range for a
                        variable, the above function searches for the line that
                        contains the specified variable abbreviation and level.
                        <center><img src='./images/HRRR_idx_description.png' width=75%  title="grib2.idx file example"></center>

                        Example: Download single variable for single day
                        <script src="https://gist.github.com/blaylockbk/57af6bae72b3f41199f2ad3583bd37a4.js"></script>

                        Example: Download single variable for date range 
                        <script src="https://gist.github.com/blaylockbk/d1978e7865490d362c9c96e1e3d4348e.js"></script>

                        Example: Download multiple variables for date range, each variable in it's own file.
                        <script src="https://gist.github.com/blaylockbk/8ff6174ec9b00c741f29f5fe76ba6a6b.js"></script>
                      
                        Example: Multithreading for fast downloads.
                        <script src="https://gist.github.com/blaylockbk/4632bfec251a85dc10dd76826af4c662.js"></script>
                        I tested the time it takes to download using 
                        a sequential download (one at a time), multiprocessing,
                        and multithreading. Multithreading is the correct way to 
                        do this. The download time saturates after about 8 threads.
                        <center><img src="./images/fast_download.png" width="450px"></center>

                        <br>
                        <p>Example: Downloading adjacent variables.
                        <p>You may be interested in retrieving more than one variable
                        at a time, and keep it all in one grib2 file.
                        This can be done by requesting a byte range that spans
                        more than one variable. This method works if the variables
                        you are interested in downloading are adjacent to each
                        other in the grib2 file. For example, if you want the 
                        10 meter U and V wind components, you are in luck
                        because they are adjacent variables. In the main function,
                        set the more_vars argument to the number of additional 
                        files to download, setting variable = to the first 
                        field you want to download.
                        <p>For example: If you want all the variables at 500 mb, 
                        set <b>variable='HGT:500 mb'</b> and set <b>more_vars=4</b>,
                        which will download
                        'HGT:500 mb', 'TMP:500 mb', 'DPT:500 mb', 'UGRD:500 mb', and 'VGRD:500 mb'
                        in the same grib2 file.
                        <script src="https://gist.github.com/blaylockbk/9ef5f3da833ce6fbf5be9334c3cf6b3d.js"></script>

                    </div>
                </div>
                
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Plot a single variable with Python and pluck a single point using cURL</h3>
                    </div>
                    <div class="panel-body">
                        <p>This example does two things:
                        <p> 1) Gets a variable from the HRRR file (2-meter temperature),
                        plots the values on a graph (you can do a basemap yourself).
                        <p> 2) Plucks out a single value at KSLC (Salt Lake City) for a time range
                        and creates a timeseries plot. Creating the time series utilizes 
                        multiprocessing to speed up the download process.
                        <script src="https://gist.github.com/blaylockbk/47357c471ceb95d7331a9a747d327b59.js"></script>
                        <img src="https://cloud.githubusercontent.com/assets/6249613/23960742/6aa2f812-096e-11e7-9a78-2591c794f58c.png" width=45% align=center>
                        <img src="https://cloud.githubusercontent.com/assets/6249613/23965054/5be4d738-097c-11e7-952f-eb34eb8fc26a.png" width=45% align=center>
                    </div>
                </div>
                
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Useful HRRR S3 Download functions</h3>
                    </div>
                    <div class="panel-body">
                        If you are patient enough to read all that, and have scrolled
                        down here, you are in luck! This is a link to the python functions
                        I use to download the HRRR data. My method is to <noscript>
                        download a single variable from a GRIB2 file that I need and
                        store it on my local drive. Then I retrieve the data I want
                        and remove the file when I got what I needed.
                        </noscript>
                        <big><a href="https://github.com/blaylockbk/pyBKB_v3/blob/master/BB_HRRR/HRRR_Pando.py">
                        <i class="fab fa-github"></i> Code for HRRR_Pando Functions</a></big>
                    </div>
                </div>

                <hr>

                <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Getting started with <b>cfgrib</b></h3>
                        </div>
                        <div class="panel-body">
                            <div class='well'>
                                <p><code>import cfgrib
                                <p>a = cfgrib.open_datasets('hrrr.t00z.wrfsfcf08.grib2')</code>
                            </div>    
                            
                            <p>The loaded data is a list of xarray dataset objects. Each item in
                                the list is an xarray dataset for a different level. For example,
                                entire atmosphere, height above ground, isobaric level, surface, etc.
                        </div>
                </div>
            </div>

            <div id="tab4" class="tab-pane fade">
                <br>
                <p>You can use <a href='https://rclone.org/'>rclone</a> to copy files from Pando to your own disk.
                <p>When you configure rclone, select 's3' as the type of storage
                    and then set everything else blank except for endpoint, which 
                    should be `https://pando-rgw01.chpc.utah.edu`.
                    <br>
                    <br>

            </div>            

            <div id="tab5" class="tab-pane fade">
                <br>
                <div class="panel panel-default">
                    <div class="panel-heading">How the .idx files are created</div>
                    <div class="panel-body" style="font-family:monospace">
                        wgrib2 hrrr.t09z.wrfsfcf17.grib2 -t -var -lev -ftime > hrrr.t09z.wrfsfcf17.grib2.idx
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">HRRR Projection Information</div>
                    <div class="panel-body">
                    Model projection is contained in the GRIB2 file, but it's kind of buried.
                    It can also be found on the <a href="https://rapidrefresh.noaa.gov/hrrr/HRRR/static/HRRRv4-Experimental/">
                        HRRR main webiste in the namelist.wps</a> file.
                    Here are the important pieces:
                    <div class="panel-body" style="font-family:monospace">
                        <p>dx = 3000,
                        <p>dy = 3000,
                        <p>map_proj =  'lambert',
                        <p>ref_lat   = 38.5,
                        <p>ref_lon   = -97.5,
                        <p>truelat1  = 38.5,
                        <p>truelat2  = 38.5,
                        <p>stand_lon = -97.5,
                    </div>
                    </div>
                </div>
                
                <div class="panel panel-default">
                    <div class="panel-heading">How do I get the latitude/longitude grid?</div>
                    <div class="panel-body">
                        <p>Latitude and longitude for every HRRR grid point is
                        defined as part of each grib message.
                        The values for each grid are not stored for each grid box (that would
                        take a lot of memory), but are calculated by the wgrib2 utility
                        with the stored projection information.
                        
                        <p>If you are using pygrib, you can get the variable data,
                        latitude, and longitude like this:
                        <span style='font-family:monospace'>value, lat, lon = grbs[1].data()</span>

                        <p>For convenience and some unique applications, I
                        created an HDF5 file that contains just the HRRR latitude
                        and longitude grids.
                        <a class='btn btn-info' href="https://pando-rgw01.chpc.utah.edu/hrrr/HRRR_latlon.h5">HRRR_latlon.h5</a>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">List of missing and incomplete files</div>
                    <div class="panel-body">
                        <a class='btn btn-default btn-lg' href='http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/HRRR_archive/PRS_missing_incomplete_files.txt'>
                                <i class="fab fa-firstdraft"></i>
                            List of Missing PRS Files</a>
                        <a class='btn btn-default btn-lg' href='http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/HRRR_archive/SFC_missing_incomplete_files.txt'>
                                <i class="fab fa-firstdraft"></i>
                            List of Missing SFC Files</a>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">Wind Vectors: Grid Relative vs Earth Relative</div>
                    <div class="panel-body">
                        <p>If you are dealing with a vector quantity,
                        like wind direction, you need to convert the
                        U and V wind component from grid-relative to
                        earth-relative to correctly orient the wind vectors.
                        <p style='text-align:center'><a class='btn btn-primary' href="https://github.com/blaylockbk/pyBKB_v2/blob/master/demos/HRRR_earthRelative_vs_gridRelative_winds.ipynb">
                            <i class="fab fa-github"></i> Convert winds Grid-relative to Earth-Relative
                        </a>
                    </div>
                </div>
            </div>            

                
            
        </div> <!--tab-content--> 

</div><!--container-->  

<hr>

<script src='./js/climate_acknowledgement.js'></script>
<script src='./js/pando_citation.js'></script>

<script src="./js/site/siteclose.js"></script>
</body>
</html>