<!DOCTYPE html>
<html>
<head>
    <title>HRRR Download Script Tips</title> 
    <script src="./js/site/siteopen.js"></script>
</head>
<body>
    <a name="TOP"></a>
    <script src="./js/site/sitemenu.js"></script>


<h1 align="center"><i class="fa fa-code fa-fw"></i> HRRR Download Scripting Tips</h1>
    
<div id="content">          
        
    <div class="row" id="content">
        <div class=" col-md-3">
                <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/hrrr_download_register.html" class="btn btn-danger btn-block">
                <i class="fa fa-user-plus"></i> Have you Registered?</a>        
        </div>
        <div class="col-md-3">
                <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/hrrr_practices.html" class="btn btn-warning btn-block">
                <i class="far fa-handshake"></i> Best Practices</a>
        </div>
        <div class="col-md-3">
                <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/hrrr_FAQ.html" class="btn btn-success btn-block">
                <i class="fa fa-info-circle"></i> HRRR FAQ</a>
        </div>
        <div class="col-md-3">
                <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/cgi-bin/hrrr_download.cgi" class="btn btn-primary btn-block">
                <i class="fa fa-cloud-download-alt"></i> Web Download Page</a>
        </div>
    </div>
    <br>
    <script src='./js/pando_status.js'></script>
    <div class="alert alert-warning">
        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
        <small><p>Reminder: Please register as a user before downloading data and 
            reference this <a href="https://doi.org/10.1016/j.cageo.2017.08.005" target="_blank">
            <b>paper</b> <i class="fa fa-book"></i></a>
        </small>
    </div> 

    <br>        
        <!-- Tabs -->
        <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#tab1">URL structure</a></li>
            <li><a data-toggle="tab" href="#tab2"><i class="fas fa-terminal"></i> cURL and wget</a></li>
            <li><a data-toggle="tab" href="#tab3"><i class="fab fa-python"></i> Python</a></li>
            <li><a data-toggle="tab" href="#tab4">Other</a></li>
        </ul>

        <div class="tab-content" id="content">
            <div id="tab1" class="tab-pane fade in active">
                <br>
                <p> You may write your own script to automate the download process,
                    but PLEASE do not download an excessive number of files in a short
                    period of time on multiple nodes (you agreed to not do this when you read the
                    Best Practices).
                <p> HRRR GRIB2 files are large. sfc files are >100 MB and prs files are >380 MB each.
                    If you download a day's worth of prs analyses, thats over 9 GB!
                <p> Feel free to share download scripts you write with <a href="mailto:brian.blaylock@utah.edu">me</a>! I'd like to make a bank of 
                    examples for all users in various languages.
                <hr>
                <p> <b>GRIB2 files</b> are downloaded from the URL<br> 
                <span style="font-family:monospace; padding-left:20px;">https://pando-rgw01.chpc.utah.edu/HRRR/<span style="color:red">[model type]</span>/<span style="color:blue">[variable field]</span>/<span style="color:green">[YYYYMMDD]</span>/<span style="color:darkorange">[file name]</span>
                <div class="alert alert-info">
                    <p> The alternative download page may help you understand the URL sturcture. <a class='btn btn-default' href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/cgi-bin/generic_pando_download.cgi?BUCKET=HRRR" data-toggle="tooltip" title="Alternative HRRR Download Page"><i class="fas fa-list"></i> Alternative HRRR Download Page</a>
                </div>

                <p> <b>Metadata</b> for each file can be viewed from the URL<br> 
                <span style="font-family:monospace; padding-left:20px;">https://api.mesowest.utah.edu/archive/HRRR/<span style="color:red">[model type]</span>/<span style="color:blue">[variable field]</span>/<span style="color:green">[YYYYMMDD]</span>/<span style="color:darkorange">[file name].idx</span>
                <p> The model type and variable field directory tree options include the following:
                <ul style="padding-left:40px">
                    <li><span style="color:red">[model type] <b>oper</b></span> for the operational HRRR
                        <ul style="padding-left:40px">
                                <li><span style="color:blue">[variable field] <b>sfc</b></span>
                                <li><span style="color:blue">[variable field] <b>prs</b></span>
                                <li><span style="color:blue">[variable field] <b>subh</b></span>
                                <li><span style="color:blue">[variable field] <b>nat</b></span> <small>(for some smaller regions and short periods of time. This is for my own research, so you probably aren't interested in these.)</small>
                        </ul>
                    <li><span style="color:red">[model type] <b>exp</b></span> for the experimental HRRR
                        <ul style="padding-left:40px">
                                <li><span style="color:blue">[variable field] <b>sfc</b></span>
                        </ul>
                    <li><span style="color:red">[model type] <b>alaska</b></span> for HRRR Alaska
                        <ul style="padding-left:40px">
                                <li><span style="color:blue">[variable field] <b>sfc</b><span>
                                <li><span style="color:blue">[variable field] <b>prs</b></span>
                        </ul>
                </ul>
                <p> <span style="color:green">[YYYYMMDD]</span> represents the UTC date format (e.g. 20170101).
                <p> <span style="color:darkorange">[file name]</span> is in the format [hrrr/hrrrX/hrrrAK].t[00-23]z.wrf[sfc/prs/subh]f[00-18 or 0-36].grib2
                
                <br>
                <br>
                <p> Each model has two different names, one for the name of the
                    directory in PANDO and a name for the model type in the file.
                
                <table style="max-width:500px" class="table table-hover">
                    <tr><th>Model Type</th>      <th>Directory Name</th><th>File Name</th></tr>
                    <tr><td>Operational HRRR</td><td>oper</td>          <td>hrrr</td></tr>
                    <tr><td>Experimental HRRR</td><td>exp</td>          <td>hrrrX</td></tr>
                    <tr><td>HRRR Alaska</td>     <td>alaska</td>        <td>hrrrAK</td></tr>
                </table>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Example</h3>
                    </div>
                    <div class="panel-body" style="font-family:monospace">
                        <p>https://pando-rgw01.chpc.utah.edu/HRRR/oper/sfc/20161225/hrrr.t00z.wrfsfcf00.grib2
                        <p>https://api.mesowest.utah.edu/archive/HRRR/oper/sfc/20161225/hrrr.t00z.wrfsfcf00.grib2.idx
                    </div>
                </div>
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">Special case: BUFR soundings</h3>
                    </div>
                    <div class="panel-body">
                        <p>You can download BUFR soundings for KSLC, KPVU, and KOGD
                            from the operational HRRR. For example:
                        <div class="well">https://pando-rgw01.chpc.utah.edu/HRRR/oper/buf/YYYYMMDD/kslc_YYYYMMDDHH.buf</div>        
                    </div>
                </div>
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">Special case: Native file subregions</h3>
                    </div>
                    <div class="panel-body">
                        <p>Some HRRR native grids are archived for a smaller subregions. I first did this for the Brian Head wildfire.
                        The time periods are for short stints and available hours may vary, so you probably arn't interested in these.
                        They are mostly for my own research. Still, the files can be downloaded, for example:
                        <div class="well" style="font-family:monospace">
                        <p>https://pando-rgw01.chpc.utah.edu/HRRR/oper/nat/20170628/hrrr.t00z.wrfnatf00.grib2.BRIANHEAD
                        <p>https://api.mesowest.utah.edu/archive/HRRR/oper/nat/20170628/hrrr.t00z.wrfnatf00.grib2.BRIANHEAD.idx
                    </div>        
                    </div>
                </div>
            

                <hr>

            </div>

            <div id="tab2" class="tab-pane fade"> 
                <br>            
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><b>cURL</b> download full file</h3>
                    </div>
                    <div class="panel-body" style="font-family:monospace">
                        curl -O https://pando-rgw01.chpc.utah.edu/HRRR/oper/sfc/20170101/hrrr.t00z.wrfsfcf00.grib2
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><b>cURL</b> download full file and rename</h3>
                    </div>
                    <div class="panel-body" style="font-family:monospace">
                        curl -o hrrr20170101_00zf00.grib2 https://pando-rgw01.chpc.utah.edu/HRRR/oper/sfc/20170101/hrrr.t00z.wrfsfcf00.grib2
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><b>wget</b> download full file</h3>
                    </div>
                    <div class="panel-body" style="font-family:monospace">
                        wget https://pando-rgw01.chpc.utah.edu/HRRR/oper/sfc/20170101/hrrr.t00z.wrfsfcf00.grib2
                    </div>
                </div>
                <p>If you know the byte range of the variable you want (found from the .idx file), you can retrieve that single variable.
                    <a href="https://api.mesowest.utah.edu/archive/HRRR" class='btn btn-primary'>Get .idx files here</a>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><b>cURL</b> download a single variable</h3>
                    </div>
                    <div class="panel-body">
                    
                    <p style="font-family:monospace">curl -o 20161101_00zf00_2mTemp.grib2 --range 33120613-34368741 https://pando-rgw01.chpc.utah.edu/HRRR/oper/sfc/20161101/hrrr.t00z.wrfsfcf00.grib2
                    </div>
                </div>
                <div class="panel panel-warning">
                    <div class="panel-heading">
                        <h3 class="panel-title"><b>cURL</b> download several variables</h3>
                    </div>
                    <div class="panel-body">
                    <p>Unfortunatly, the <span style="font-family:monospace">curl --range</span> function wont work if you
                        request more than one range. I don't know why this doesn't
                        work, but it must be a limitation of the Pando archive.
                        Fortunately, similar variables are usually grouped together,
                        like U and V wind compenents, so you can request a range 
                        that spans the variables you want. This example gets 
                        TMP, POT, SPFH, DPT, RH, UGRD, VGRD, WIND at 2 meters.
                    <p style="font-family:monospace">curl -o 20161101_00zf00_2mTemp2mDPT10mwind.grib2 --range 33120613-42997512 https://pando-rgw01.chpc.utah.edu/HRRR/oper/sfc/20161101/hrrr.t00z.wrfsfcf00.grib2
                    </div>
                </div>
                
            </div>

            <div id="tab3" class="tab-pane fade">
                <br>
                <p> I use python/2.7.11. Describing my set-up would be long, so just use these as a template.
                
                <br>
                
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Download full grib2 files</h3>
                    </div>
                    <div class="panel-body">
                        Download the full grib2 file from the Pando archive.
                        'sfc' files are about 150 MB each, and 'prs' files are
                        about 320 MB each.
                        <script src="https://gist.github.com/blaylockbk/78d4dd9c159e8974f288b0a57f68c266.js"></script>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Download single HRRR variable from file</h3>
                    </div>
                    <div class="panel-body">
                        It is more efficient if you only download the variables
                        you are interested in. While a full sfc file is about
                        150 MB, a single variable field is about 1 MB.
                        You can perform partial downloads of the grib2 files to 
                        extract the variables you want with cURL.
                        <br><br>
                        Main function: <b>download_HRRR_variable_from_pando()</b>
                        <script src="https://gist.github.com/blaylockbk/39d2c5244b988706d9c51dd9fd514650.js"></script>
                                       
                        Partial downloads with cURL require a known byte range.
                        The grbi2.idx (
                        <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/HRRR_archive/HRRR_v3_variables_SFC.pdf">
                        sfc example</a>
                        ,   
                        <a href="http://home.chpc.utah.edu/~u0553130/Brian_Blaylock/HRRR_archive/HRRR_v3_variables_PRS.pdf">
                        prs example</a>
                        ) files are metadata text files that 
                        contain the begining byte of each
                        field in the file. <b>Each grib2 file has a unique
                        metadata file.</b> To find the byte range for a
                        variable, the above function searches for the line that
                        contains the specified variable abbreviation and level.
                        <center><img src='./images/HRRR_idx_description.png' width=75%  title="grib2.idx file example"></center>

                        Example: Download single variable for single day
                        <script src="https://gist.github.com/blaylockbk/57af6bae72b3f41199f2ad3583bd37a4.js"></script>

                        Example: Download single variable for date range 
                        <script src="https://gist.github.com/blaylockbk/d1978e7865490d362c9c96e1e3d4348e.js"></script>

                        Example: Download multiple variables for date range, each variable in it's own file.
                        <script src="https://gist.github.com/blaylockbk/8ff6174ec9b00c741f29f5fe76ba6a6b.js"></script>
                      
                        Example: Multithreading for fast downloads.
                        <script src="https://gist.github.com/blaylockbk/4632bfec251a85dc10dd76826af4c662.js"></script>
                        I tested the time it takes to download using 
                        a sequential download (one at a time), multiprocessing,
                        and multithreading. Multithreading is the correct way to 
                        do this. The download time saturates after about 8 threads.
                        <center><img src="./images/fast_download.png" width="450px"></center>

                        <br>
                        <p>Example: Downloading adjacent variables.
                        <p>You may be interested in retrieving more than one variable
                        at a time, and keep it all in one grib2 file.
                        This can be done by requesting a byte range that spans
                        more than one variable. This method works if the variables
                        you are interested in downloading are adjacent to each
                        other in the grib2 file. For example, if you want the 
                        10 meter U and V wind components, you are in luck
                        because they are adjacent variables. In the main function,
                        set the more_vars argument to the number of additional 
                        files to download, setting variable = to the first 
                        field you want to download.
                        <p>For example: If you want all the variables at 500 mb, 
                        set <b>variable='HGT:500 mb'</b> and set <b>more_vars=4</b>,
                        which will download
                        'HGT:500 mb', 'TMP:500 mb', 'DPT:500 mb', 'UGRD:500 mb', and 'VGRD:500 mb'
                        in the same grib2 file.
                        <script src="https://gist.github.com/blaylockbk/9ef5f3da833ce6fbf5be9334c3cf6b3d.js"></script>

                    </div>
                </div>
                
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Plot a single variable with Python and pluck a single point using cURL</h3>
                    </div>
                    <div class="panel-body">
                        <p>This example does two things:
                        <p> 1) Gets a variable from the HRRR file (2-meter temperature),
                        plots the values on a graph (you can do a basemap yourself).
                        <p> 2) Plucks out a single value at KSLC (Salt Lake City) for a time range
                        and creates a timeseries plot. Creating the time series utilizes 
                        multiprocessing to speed up the download process.
                        <script src="https://gist.github.com/blaylockbk/47357c471ceb95d7331a9a747d327b59.js"></script>
                        <img src="https://cloud.githubusercontent.com/assets/6249613/23960742/6aa2f812-096e-11e7-9a78-2591c794f58c.png" width=45% align=center>
                        <img src="https://cloud.githubusercontent.com/assets/6249613/23965054/5be4d738-097c-11e7-952f-eb34eb8fc26a.png" width=45% align=center>
                    </div>
                </div>
                
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Useful HRRR S3 Download functions</h3>
                    </div>
                    <div class="panel-body">
                        If you are patient enough to read all that, and have scrolled
                        down here, you're in luck! This is a link to the python functions
                        I use to download the HRRR data. My method is to <noscript>
                        store any grib2 files on my local drive. I download the 
                        grib2 file when I need it, and remove it after I've extrated
                        the info I need.
                        </noscript>
                        <big><a href="https://github.com/blaylockbk/pyBKB_v2/blob/master/BB_downloads/HRRR_S3.py">
                        <i class="fab fa-github"></i> Code for HRRR_S3 Functions</a></big>
                    </div>
                </div>
            </div>

            <div id="tab4" class="tab-pane fade">
                <br>
                Byte ranges for each variable are found in an .idx file located here:
                <a href="https://api.mesowest.utah.edu/archive/HRRR" class='btn btn-primary'>Get .idx files here</a>
                <br><br>
                <div class="panel panel-default">
                <div class="panel-heading">How the .idx files were created</div>
                <div class="panel-body" style="font-family:monospace">
                wgrib2 hrrr.t09z.wrfsfcf17.grib2 -t -var -lev -ftime
                </div>
                </div>
            </div>            

                
            
        </div> <!--tab-conent--> 

</div><!--container-->  
<div class='well well-sm' style="padding-left:10px;padding-right:10px;margin-bottom:-20">
    <div class='container'>
        <h3>Citation Details</h3>
        <p><i class="fa fa-fw fa-database" aria-hidden="true"></i> HRRR archive data:
        <p style='padding-left:55px'> doi: <a href="https://doi.org/10.7278/S5JQ0Z5B" target="_blank">10.7278/S5JQ0Z5B</a>
        <p><i class="fa fa-fw fa-book" aria-hidden="true"></i> Journal article describing how the archive is built:
        <p style="padding-left:55px"><i>Blaylock B., J. Horel and S. Liston, 2017: Cloud Archiving and
            Data Mining of High Resolution Rapid Refresh Model Output. 
            Computers and Geosciences. Accepted.
            <a herf="https://doi.org/10.1016/j.cageo.2017.08.005" target="_blank">https://doi.org/10.1016/j.cageo.2017.08.005</a></i>
    </div>
</div>

<script src="./js/site/siteclose.js"></script>
</body>
</html>